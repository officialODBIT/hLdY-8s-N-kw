<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Chatbot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .message {
      margin-bottom: 15px;
      white-space: pre-wrap;
    }

    .user {
      color: #00f;
    }

    .bot {
      color: #fff;
    }

    .code-block {
      background: #222;
      border: 1px solid #444;
      padding: 10px;
      margin-top: 8px;
      font-family: monospace;
      color: #0f0;
      border-radius: 6px;
      overflow-x: auto;
    }

    #inputBar {
      display: flex;
      border-top: 1px solid #444;
    }

    #userInput {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      background: #222;
      color: #fff;
      border: none;
    }

    #sendBtn {
      padding: 10px 20px;
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    #sendBtn:hover {
      background: #444;
    }
  </style>
</head>
<body>

  <div id="chat"></div>

  <div id="inputBar">
    <input type="text" id="userInput" placeholder="Type your message..." />
    <button id="sendBtn">Send</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCtWG6vjbkouBB48x3V2AhgCHU-ab1p5Nw",
      authDomain: "odbit-chatbot-api.firebaseapp.com",
      projectId: "odbit-chatbot-api",
      storageBucket: "odbit-chatbot-api.firebasestorage.app",
      messagingSenderId: "859761217662",
      appId: "1:859761217662:web:8888884ce4389667c0482f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");

    let openaiKey = null;

    async function loadAPIKey() {
      const docRef = doc(db, "api", "apikey");
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        openaiKey = docSnap.data().key;
      } else {
        alert("API key not found in Firestore.");
      }
    }

    async function sendToOpenAI(message) {
      if (!openaiKey) {
        console.error("API key not loaded.");
        return "API key error.";
      }

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${openaiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [
            {
              role: "system",
              content: "You're a calm, friendly, and encouraging expert in Roblox Luau scripting â€” the best of the best. You write clean, efficient, and modern code, and always avoid deprecated functions or outdated practices. You patiently guide the user through any problem, recognize their skill level or frustration, and explain things clearly with care. Always wrap any code you provide in triple backticks for clean formatting, and offer tips or alternatives when appropriate. Also, when providing Luau code, say whether its a Localscript, script, or modulescript. Also, please have the FRIENDLIEST tone you can possibly have. Although, don't agree with things that are false. Always correct in a non-rude manner and tone."
            },
            {
              role: "user",
              content: message
            }
          ]
        })
      });

      const data = await response.json();
      return data.choices?.[0]?.message?.content || "Error from OpenAI.";
    }

    function addMessage(role, text) {
      const div = document.createElement("div");
      div.className = "message " + role;

      if (role === "bot") {
        // Format code blocks if present
        const parts = text.split(/```/);
        if (parts.length > 1) {
          const [before, code, ...rest] = parts;
          div.innerHTML = `<span>${role === "user" ? "You" : "Bot"}: ${before.trim()}</span>`;
          const codeBlock = document.createElement("div");
          codeBlock.className = "code-block";
          codeBlock.textContent = code.trim();
          div.appendChild(codeBlock);
          if (rest.length) {
            div.innerHTML += `<span>${rest.join("```").trim()}</span>`;
          }
        } else {
          div.textContent = `${role === "user" ? "You" : "Bot"}: ${text}`;
        }
      } else {
        div.textContent = `${role === "user" ? "You" : "Bot"}: ${text}`;
      }

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    sendBtn.addEventListener("click", async () => {
      const message = input.value.trim();
      if (!message) return;
      addMessage("user", message);
      input.value = "";
      const reply = await sendToOpenAI(message);
      addMessage("bot", reply);
    });

    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    loadAPIKey();
  </script>

</body>
</html>
